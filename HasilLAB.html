<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB IPAL</title>
    <link rel="stylesheet" href="titik3.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="debit.css">
    <link rel="shortcut icon" href="https://ik.imagekit.io/galleryBiden/foto/ee.png?updatedAt=1760149223469" type="image/x-icon">
  </head>
  <body>
    <div class="kon1">
      <button class="btnOpsi" onclick="window.location.href='index.html'">HOME</button>
      <button class="btnOpsi" onclick="window.location.href='msds.html'">MSDS</button>
      <button class="btnOpsi" onclick="window.location.href='wi.html'">WORK INSTRUCTION</button>
    </div>

    <div class="container">
      <h1 class="text-center mb-4">Hasil LAB IPAL</h1>

      <!-- Dropdown filter bulan -->
      <div class="mb-3 text-left">
        <label for="bulanFilter" class="form-label fw-bold">Bulan:</label>
        <select id="bulanFilter" class="form-select w-auto d-inline-block" onchange="filterBulan()">
          <option value="">All</option>
          <option value="01">Januari</option>
          <option value="02">Februari</option>
          <option value="03">Maret</option>
          <option value="04">April</option>
          <option value="05">Mei</option>
          <option value="06">Juni</option>
          <option value="07">Juli</option>
          <option value="08">Agustus</option>
          <option value="09">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="dataTable">
          <thead class="table-dark">
            <tr id="tableHead" class="text-center">
              <th>Loading bang......</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="text-center">
            <tr><td>Tunggu Bentarr...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyScDvv2xn_7_bxjo6769sU5z25aLwiuK-jSG--aoC3OmluMRq5mcs38tHk6f7A6dfk/exec";
  let allData = []; // data asli dari GAS

  // ----- helper: ambil bulan dari berbagai format tanggal -----
  function parseMonthFromCell(val) {
  if (!val) return null;

  const s = String(val).trim();
  if (s === "") return null;

  // --- cek angka murni (serial / epoch) ---
  if (!isNaN(s) && s.length > 4) {
    const d = new Date(Number(s));
    if (!isNaN(d)) return String(d.getMonth() + 1).padStart(2, "0");
  }

  // --- mapping nama bulan ---
  const bulanMap = {
    januari: "01",
    februari: "02",
    maret: "03",
    april: "04",
    mei: "05",
    juni: "06",
    juli: "07",
    agustus: "08",
    september: "09",
    oktober: "10",
    november: "11",
    desember: "12"
  };

  // cek apakah mengandung nama bulan
  const lower = s.toLowerCase();
  for (const [nama, kode] of Object.entries(bulanMap)) {
    if (lower.includes(nama)) {
      return kode;
    }
  }

  // --- format numerik umum: D/M/YY atau YYYY-MM-DD ---
  const regex1 = /^\d{1,2}[-/]\d{1,2}[-/]\d{2,4}$/;
  const regex2 = /^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/;

  if (regex1.test(s) || regex2.test(s)) {
    const p = s.split(/[-/]/);
    if (p.length >= 2) {
      return String(parseInt(p[1], 10)).padStart(2, "0");
    }
  }

  // --- fallback: Date() parser internasional ---
  const d = new Date(s);
  if (!isNaN(d)) return String(d.getMonth() + 1).padStart(2, "0");

  return null;
}


  // ----- render tabel; aman bila data kosong -----
  function renderTable(dataArr) {
    const headRow = document.getElementById("tableHead");
    const bodyTable = document.getElementById("tableBody");

    if (!dataArr || dataArr.length === 0) {
      // gunakan header dari allData jika tersedia, kalau tidak tampilkan placeholder
      const headers = (allData && allData.length) ? Object.keys(allData[0]) : ["Info"];
      headRow.innerHTML = headers.map(h => `<th>${h}</th>`).join("");
      bodyTable.innerHTML = `<tr><td colspan="${headers.length}">Gak ada ya</td></tr>`;
      return;
    }

    const headers = Object.keys(dataArr[0]);
    headRow.innerHTML = headers.map(h => `<th>${h}</th>`).join("");
    bodyTable.innerHTML = dataArr
      .map(row => `<tr>${headers.map(h => `<td>${row[h] ?? ""}</td>`).join("")}</tr>`)
      .join("");
  }

  // ----- fungsi filter bulan (menggunakan parser di atas) -----
  function filterBulan() {
    const selected = document.getElementById("bulanFilter").value;
    const selectedTwo = String(selected).padStart(2, "0");

    // debug singkat (bisa dihapus nanti)
    // console.log("Selected month:", selectedTwo);

    // selalu filter dari data penuh
    const source = [...allData];

    if (!selected) {
      renderTable(source);
      return;
    }

    const filtered = source.filter(item => {
      const bulan = parseMonthFromCell(item.Tanggal);
      // console.log(item.Tanggal, "->", bulan); // aktifkan untuk debugging baris per baris
      return bulan === selectedTwo;
    });

    renderTable(filtered);
  }

  // ----- callback JSONP dari GAS -----
  function tampilkanData(data) {
    if (!data || !data.hasil) {
      document.getElementById("tableHead").innerHTML = "<th>Tidak ada data</th>";
      document.getElementById("tableBody").innerHTML = "<tr><td>Kosong</td></tr>";
      return;
    }

    allData = data.hasil;
    // Pastikan tabel awal dibuat (pakai header dari data asli)
    renderTable(allData);

    // optional: tunjukkan contoh format tanggal di console (untuk debug)
    if (allData.length) {
      console.log("Contoh Tanggal (3 pertama):", allData.slice(0,3).map(r => ({raw: r.Tanggal, parsed: parseMonthFromCell(r.Tanggal)})));
    }
  }

  // panggil GAS via JSONP
  const script = document.createElement("script");
  script.src = GAS_URL + "?callback=tampilkanData";
  document.body.appendChild(script);
</script>


    <!-- Navigasi bawah -->
    <div class="mudun" id="menu1">
      <button class="menu-btn">ðŸ§­</button>
      <div class="mudun-content">
        <a href="DebitSTP.html">Debit STP</a>
        <a href="DebitWWTP.html">Debit WWTP</a>
        <a href="HasilLAB.html">Hasil LAB Internal</a>
      </div>
    </div>

    <script>
      // Event menu bawah
      document.querySelectorAll('.mudun').forEach(drop => {
        const btn = drop.querySelector('.menu-btn');
        btn.addEventListener('click', e => {
          e.stopPropagation();
          document.querySelectorAll('.mudun').forEach(d => {
            if (d !== drop) d.classList.remove('show');
          });
          drop.classList.toggle('show');
        });
      });

      document.addEventListener('click', () => {
        document.querySelectorAll('.mudun').forEach(d => d.classList.remove('show'));
      });
    </script>
  </body>
</html>
